!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Carn=t()}}((function(){var t={};Object.defineProperty(t,"__esModule",{value:!0}),t.Carn=void 0;class s{constructor(t){this.start=-1,this.finish=-1,this.errs=[],this.bail=!0,this.id=t,this.run=-1}error(t,s,...e){let n=new i(this.id,this.run,t,s,...e);if(this.errs.push(n),this.bail)throw n;return n}throw(t,s,...i){throw this.error(t,s,...i)}init(t){this.run=t,this.start=Date.now(),this.bail=!1}check(){return this.active()||this.throw("not_active")}active(){return 0<this.start&&this.finish<0}finished(){return 0<this.finish}}class i extends Error{constructor(t,s,e,n,...r){(r="string"==typeof n?[n,...r]:r&&"string"==typeof r[0]?r:[i.Code[e]||e,...r])[0]+=` [id=${t},run=${s}]`+(n?" {"+Object.keys(n).map(t=>t+":"+n[t])+"}":""),super(...r),this.code=e,this.cid=t,this.crun=s}}i.Code={not_active:"Carn instance is not active (call Carn.start())",already_started:"Carn instance is already started",invalid_depth:"Invalid depth (<0)"},t.Carn=class{constructor(){this.newline="\n",this.indent="  ",this.separator=",",this.dI=0,this.id=1e6*Math.random()|0,this.run=-1,this.s=[],this.ctx=new s(this.id)}start(){return-1==this.ctx.start||this.ctx.finished()?(this.s=[],this.run=1e6*Math.random()|0,this.ctx=new s(this.id),this.ctx.init(this.run)):this.ctx.error("already_started"),this.ctx}add(t){this.ctx.check(),"string"==typeof t&&this.s.push(t)}sep(){this.ctx.check(),this.s.push(new n(this.separator))}depth(t,s){if(this.ctx.check(),"number"==typeof t){let i=(s=null==s||!!s)?this.dI+t:t;i<0&&this.ctx.error("invalid_depth",{move:t,relative:s,depth:i}),this.dI=i,this.s.push(new e(this.dI,this.indent))}return this.dI}finish(){return this.ctx.check(),this.ctx.finish=Date.now(),this.ctx}src(){this.ctx.start<0&&this.ctx.throw("not_active");let t="";for(let s=0;s<this.s.length;s++){let i=s;this.s[i]instanceof e?(t=this.s[i].toString(),this.s[i]=""):(this.s[i+1]instanceof n&&(this.s[i+2]instanceof e||(this.s[i]+=this.s[i+1].toString()),this.s[i+1]="",s++),this.s[i]=t+this.s[i]+this.newline)}return this.s.join("")}inject(t,s,i){let e=this.src();e=e.startsWith("\n")?e:"\n"+e,e=e.endsWith("\n")?e:e+"\n";let n=i[0],r=i[1];const h=new RegExp(n+"START:"+s+r+".*?"+n+"END:"+s+r,"s");return t.replace(h,n+"START:"+s+r+e+n+"END:"+s+r)}};class e{constructor(t,s){this.depth=null==t||t<0?0:t,this.indent=s}toString(){return this.indent.repeat(isNaN(this.depth)?0:this.depth)}}class n{constructor(t){this.separator=t}toString(){return this.separator}}return t}));